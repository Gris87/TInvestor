name: clang-tidy
description: Clang-Tidy
runs:
  using: "composite"
  steps:
    # Set git to disable line endings conversion
    - name: Configure git
      shell: pwsh
      run: |
        & git config --global core.autocrlf false

    # Checkout latest commit for this repository to $GITHUB_WORKSPACE/TInvestor-source
    - name: Checkout TInvestor
      uses: actions/checkout@v4
      with:
        path: TInvestor-source

    # Calculate TInvestor hash on sources
    - name: Calculate TInvestor hash
      id: folders-hash
      uses: theowenyoung/folder-hash@v3
      with:
        path: |
          ./TInvestor-source/app
          ./TInvestor-source/libs
          ./TInvestor-source/test

    # Download/upload cache
    - name: Caching
      uses: actions/cache@v4
      id: cache-clang-tidy
      with:
        path: ./success
        key: ${{ runner.os }}-clang-tidy-${{ steps.folders-hash.outputs.hash }}

    # Download environment artifacts
    - name: Download environment artifacts (Qt/ZLib/Quazip)
      if: steps.cache-build.outputs.cache-hit != 'true'
      uses: thebrowsercompany/gha-download-tar-artifact@main
      with:
        name: env-qt-zlib-quazip-${{ matrix.config.name }}
        path: ./Qt

    # Download environment artifacts
    - name: Download environment artifacts (vcpkg)
      if: steps.cache-build.outputs.cache-hit != 'true'
      uses: thebrowsercompany/gha-download-tar-artifact@main
      with:
        name: env-vcpkg-${{ matrix.config.name }}
        path: ./Qt

    # Checkout googletest repository with specific version to $GITHUB_WORKSPACE/googletest-source
    - name: Checkout googletest
      if: steps.cache-build.outputs.cache-hit != 'true'
      uses: actions/checkout@v4
      with:
        repository: google/googletest
        path: Qt/googletest-source
        ref: ${{ env.GOOGLE_TEST_VERSION }}

    # Download build artifacts (Debug)
    - name: Download build artifacts (Debug)
      if: steps.cache-clang-tidy.outputs.cache-hit != 'true'
      uses: thebrowsercompany/gha-download-tar-artifact@main
      with:
        name: build-debug-${{ matrix.config.name }}
        path: ./TInvestor-source/build/Desktop-Debug

    # Test TInvestor
    - name: Test TInvestor
      if: steps.cache-clang-tidy.outputs.cache-hit != 'true'
      shell: pwsh
      run: |
        switch ("${{ runner.os }}")
        {
            "Windows" {
                ${Env:PATH} = "${Env:GITHUB_WORKSPACE}/Qt/qtcreator-windows-x64-msvc-${Env:QTC_VERSION}/bin/clang/bin;${Env:PATH}"
            }
            "Linux" {
                ${Env:PATH} = "${Env:GITHUB_WORKSPACE}/Qt/qtcreator-linux-x64-${Env:QTC_VERSION}/libexec/qtcreator/clang/bin:${Env:PATH}"
            }
        }

        # Enter to TInvestor-source folder
        Set-Location -Path "TInvestor-source"

        & python tools/py3/run-clang-tidy

    # Finish
    - name: Finish
      shell: pwsh
      run: |
        Write-Output "Finished"
